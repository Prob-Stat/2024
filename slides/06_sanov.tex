\documentclass[lualatex,handout]{beamer}
\setbeamertemplate{footline}[frame number]
\usepackage{luatexja}
\usepackage{amsmath,amssymb}

\usepackage{thm-restate}

%\usetheme{Berlin}
\usecolortheme{rose}

\usepackage{tikz}
\usepackage{pgfplots}
\pgfplotsset{compat=1.18}

%\usepackage[haranoaji]{luatexja-preset}
\usepackage[deluxe,ipaex]{luatexja-preset}
\renewcommand{\kanjifamilydefault}{\gtdefault}
%\setmainjfont{HaranoAjiGothic-Regular}

\usepackage{unicode-math}
%\setmathfont{Fira Math}
\setmathfont{STIX Two Math}
\setmathfont{STIX Two Math}[range=bfup/{Latin,latin,num,Greek,greek}]
\setmathfont{STIX Two Math}[range=bfit/{Latin,latin}]
\setmathfont{STIX Two Math}[range={"0000-"FFFF}]
\setmathrm{STIX Two Math}[StylisticSet=8]

%\usefonttheme{professionalfonts}

\usepackage{luacolor}

\newcommand{\mycolor}[2]{%
  \begingroup
  \colorlet{currentcolor}{.}%
  \color{#1}#2%
  \color{currentcolor}%
  \endgroup
}
\newcommand{\emm}[1]{\mycolor{red}{#1}}
\newcommand{\expt}[1]{\mathbb{E}\left[#1\right]}
\newcommand{\var}[1]{\mathbb{V}\left[#1\right]}
\newcommand{\cov}[1]{\mathsf{Cov}\left[#1\right]}
\newcommand{\vc}[1]{\mathsf{Var}\left[#1\right]}


\usepackage{xspace}
%\usepackage{bm}
%\newcommand\bm[1]{{\mathbf{#1}}}
\newcommand\dx{{\,\mathrm{d}x}}
\newcommand\KL[2]{D(#1\,\|\,#2)}

\theoremstyle{definition}

\title{確率・統計基礎: サノフの定理、エントロピー、KLダイバージェンス、}
\author{森 立平}
\date{}



\begin{document}
\begin{frame}[plain]
\maketitle
\end{frame}

\begin{frame}{経験分布の集中}
大数の法則や中心極限定理と同様にi.i.d.確率変数$X_1,X_2,\dotsc,X_N$を考える。

\vspace{1em}
%\begin{definition}
確率変数$X$の像が\emm{有限集合}$A$とする。

各$a\in A$について$N_a := \{ k\mid X_k = a\}$とおく。

$\left(\frac{N_a}{N}\right)_{a\in A}$を経験分布という。
%\end{definition}

\vspace{1em}
サイコロを100回振って1,2,3,4,5,6がそれぞれ16,13,18,20,14,19回出たとき経験分布は
\begin{align*}
P(1) &= \frac{16}{100}&
P(2) &= \frac{13}{100}&
P(3) &= \frac{18}{100}\\
P(4) &= \frac{20}{100}&
P(5) &= \frac{14}{100}&
P(6) &= \frac{19}{100}
\end{align*}
である。
\end{frame}

\begin{frame}{経験分布}
\footnotesize
\emm{有限集合}$A=\{1,2,\dotsc,\emm{m}\}$とする。
$\mathcal{P}\coloneq\{(p_1,\dotsc,p_m)\in\mathbb{R}_{\ge 0}^m\mid p_1+\dotsb+p_m=1\}$.
\begin{definition}
%確率変数$X$の像が\emm{有限集合}$A=\{1,2,\dotsc,m\}$とする。
%\vspace{-1em}
任意の$N\in\mathbb{Z}_{> 0}$について
\begin{align*}
\mathcal{P}_N &\coloneq \left\{ \left(\frac{N_1}{N}, \frac{N_2}{N},\dotsc, \frac{N_m}{N}\right)\;\middle|\; 
\begin{gathered}
(N_1,\dotsc,N_m)\in\mathbb{Z}_{\ge 0}^m\\
N_1+N_2+\dotsb+N_m=N
\end{gathered}\right\}
%\mathcal{P}_{\symbf{x}}&\coloneq \left(\frac{N_1(\symbf{x})}{N}, \frac{N_2(\symbf{x})}{N},\dotsc, \frac{N_m}{N(\symbf{x})}\right)
%\qquad\text{where $N_k(\symbf{x})$ は$\symbf{x}$に含まれる$k$の数} 
\end{align*}
とする。
%
任意の$\symbf{x}\in A^N$について、\emm{経験分布}$P_{\symbf{x}}\in\mathcal{P}_N$は
\begin{align*}
P_{\symbf{x}}&\coloneq \left(\frac{N_1(\symbf{x})}{N}, \frac{N_2(\symbf{x})}{N},\dotsc, \frac{N_m(\symbf{x})}{N}\right).
\end{align*}
%各$a\in A$について$N_a := \{ k\mid X_k = a\}$とおく。
ここで$k=1,2,\dotsc,m$について $N_k(\symbf{x})$ は$\symbf{x}$に含まれる$k$の数。

%$\left(\frac{N_a}{N}\right)_{a\in A}$を経験分布という。
\end{definition}
\begin{example}
$m=2$のとき、
\begin{align*}
\mathcal{P}_3&=\left\{\left(\frac{0}{3},\,\frac{3}{3}\right),\,\left(\frac{1}{3},\,\frac{2}{3}\right),\,\left(\frac{2}{3},\,\frac{1}{3}\right),\,\left(\frac{3}{3},\,\frac{0}{3}\right)\right\}\\
P_{12211}&= \left(\frac{3}{5},\,\frac{2}{5}\right)
\end{align*}
\end{example}
\end{frame}

\begin{frame}{Kullback--Libler divergence}
\begin{definition}[Kullback--Libler divergence]
$D\colon \mathcal{P}\times\mathcal{P}\to\mathbb{R}$を以下で定義する
\begin{align*}
\KL{q}{p} &\coloneq \sum_{k=1}^m q_k\log \frac{q_k}{p_k}.
\end{align*}
ただし、ある$k$について$p_k=0,\,q_k>0$のとき$\KL{q}{p}$は定義されない。
\end{definition}
\begin{lemma}
\begin{itemize}
\item $\KL{q}{p}\ge 0$
\item $\KL{q}{p}= 0\iff q=p$
\end{itemize}
\end{lemma}
\end{frame}

\begin{frame}{サノフの定理}
%\begin{theorem}[サノフの定理]
\begin{restatable}[サノフの定理]{theorem}{sanov}
任意の$\mathcal{D}\subseteq\mathcal{P}$について
\begin{align*}
\Pr\left(P_{\symbf{X}} \in \mathcal{D}\right) &\le (N+1)^m \mathrm{e}^{-N\inf_{q\in \mathcal{D}} \emm{\KL{q}{p}}}.
\end{align*}
また任意の開集合$\mathcal{D}\subseteq\mathcal{P}$について
\begin{align*}
\lim_{N\to\infty}\frac1N\log \Pr\left(P_{\symbf{X}} \in \mathcal{D}\right) &= -\inf_{q\in \mathcal{D}} \emm{\KL{q}{p}}.
\end{align*}
\end{restatable}
%\end{theorem}
\end{frame}



\if0
\begin{frame}{$n!$の上下界}
\footnotesize
\begin{lemma}
任意の自然数$n$について
\begin{align*}
\left(\frac{n}{\mathrm{e}}\right)^n\le n!\le n^n.
\end{align*}
\vspace{-1em}
\begin{proof}
$n!\le n^n$は自明である。以下では$\frac1{n!}\le \left(\frac{\mathrm{e}}{n}\right)^n$を示す。
%
$C_r$を原点を中心とした半径$r$の円を反時計回りに回るパスとすると、任意の$r>0$について
\begin{align*}
\frac1{n!} &= \frac1{2\pi i} \oint_{C_r} \frac{\mathrm{e}^z}{z^{n+1}}\mathrm{d}z\\
 &= \left|\frac1{2\pi i} \oint_{C_r} \frac{\mathrm{e}^z}{z^{n+1}}\mathrm{d}z\right|\\
&\le \frac1{2\pi } \oint_{C_r} \left|\frac{\mathrm{e}^z}{z^{n+1}}\right|\mathrm{d}z\\
&\le \frac1{2\pi } (2\pi r) \frac{\mathrm{e}^r}{r^{n+1}} = \frac{\mathrm{e}^r}{r^n}
\end{align*}
である。この上界は$r=n$のときに最小化されて$\frac1{n!}\le\left(\frac{\mathrm{e}}{n}\right)^n$を得る。
\end{proof}
\end{lemma}
\end{frame}
\fi

\begin{frame}{特定の経験分布になる確率の上下界 1/3}
\small
\begin{lemma}
任意の$q\in\mathcal{P}_N$について
\begin{align*}
\frac1{(N+1)^m}\mathrm{e}^{-N \KL{q}{p}}\le
%\binom{N}{N_1\,N_2\,\dotsm N_m}
%\Pr(\symbf{X}\in T_q)
\Pr(P_{\symbf{X}} = q)
\le \mathrm{e}^{-N \KL{q}{p}}.
\end{align*}
\end{lemma}
\begin{proof}
\vspace{-2em}
%上界の証明:
%任意の$N_1$と$p \in\mathcal{P}_m$について
\begin{align*}
\Pr(P_{\symbf{X}}= q) &= \binom{N}{Nq_1\,Nq_2\,\dotsm Nq_m} \prod_{k=1}^m p_k^{Nq_k}\\
 &= \emm{\binom{N}{Nq_1\,Nq_2\,\dotsm Nq_m} \prod_{k=1}^m q_k^{Nq_k}}\prod_{k=1}^m\frac{p_k^{Nq_k}}{q_k^{Nq_k}}\\
 &= \emm{\Pr(P_{\symbf{Y}}= q)}\prod_{k=1}^m\left(\frac{p_k}{q_k}\right)^{Nq_k}\\
 &=\emm{\Pr(P_{\symbf{Y}}= q)}\mathrm{e}^{-N \KL{q}{p}}.
%=\mathrm{e}^{-N \KL{q}{p}}.
\end{align*}
ここで$\symbf{Y}$は$\mathrm{Multinom}(q)$に従う確率変数。
%よって$\frac1{(N+1)^m}\le\Pr(\symbf{Y}\in T_q)\le 1$を示せばよいが上界は明らか。
\end{proof}
\end{frame}

\begin{frame}{特定の経験分布になる確率の上下界 2/3}
\footnotesize
\begin{lemma}
任意の$q\in\mathcal{P}_N$について
\begin{align*}
\frac1{(N+1)^m}\mathrm{e}^{-N \KL{q}{p}}\le
%\binom{N}{N_1\,N_2\,\dotsm N_m}
\Pr(P_{\symbf{X}} = q)
\le \mathrm{e}^{-N \KL{q}{p}}
\end{align*}
\end{lemma}
\begin{proof}
\vspace{-2em}
\begin{align*}
\Pr(P_{\symbf{X}}= q) &= \emm{\Pr(P_{\symbf{Y}}= q)}\mathrm{e}^{-N \KL{q}{p}}.
\end{align*}
よって$\frac1{(N+1)^m}\le\Pr(P_{\symbf{Y}}= q)\le 1$を示せばよいが上界は明らか。

%下界の証明:
%任意の$N_1$と$p \in\mathcal{P}_m$について
%
任意の$p'\in\mathcal{P}_N$について
\begin{align*}
\Pr\left(P_{\symbf{Y}}= p'\right)&\le
\Pr\left(P_{\symbf{Y}}= q\right)
\end{align*}
が成り立つと仮定する(後で証明する)と、
\begin{align*}
1&=\sum_{p'\in\mathcal{P}_N} \Pr\left(P_{\symbf{Y}}= p'\right)
\le\sum_{p'\in\mathcal{P}_N} \Pr\left(P_{\symbf{Y}}= q\right)
=|\mathcal{P}_N| \Pr\left(P_{\symbf{Y}}= q\right)
\end{align*}
であるが$|\mathcal{P}_N|=\binom{N+m-1}{m-1}\le (N+1)^m$より下界を得る。
\end{proof}
\end{frame}

\begin{frame}{特定の経験分布になる確率の上下界 3/3}
\small
最後に
\begin{align*}
\Pr\left(P_{\symbf{Y}}= p'\right)&\le
\Pr\left(P_{\symbf{Y}}= q\right)
\end{align*}
を示せばよい。
\begin{align*}
\Pr(P_{\symbf{Y}}= p') &= \binom{N}{Np'_1\,Np'_2\,\dotsm Np'_m} \prod_{k=1}^m q_k^{Np'_k}\\
\Pr(P_{\symbf{Y}}= q) &= \binom{N}{Nq_1\,Nq_2\,\dotsm Nq_m} \prod_{k=1}^m q_k^{Nq_k}
\end{align*}
\begin{align*}
\frac{\Pr(P_{\symbf{Y}}= p')}{\Pr(P_{\symbf{Y}}= q)}&=\prod_{k=1}^m\frac{(Nq_k)!\cdot q_k^{Np'_k}}{(Np'_k)!\cdot q_k^{Nq_k}}\\
&=\prod_{k=1}^m\frac{(Nq_k)!\cdot (Nq_k)^{Np'_k}}{(Np'_k)!\cdot (Nq_k)^{Nq_k}}\\
\end{align*}
\end{frame}

\begin{frame}{サノフの定理の証明}
\footnotesize
\sanov
\begin{proof}
\vspace{-2em}
\begin{align*}
\Pr(P_{\symbf{X}}\in\mathcal{D}) &= \sum_{q\in\mathcal{D}\cap\mathcal{P}_N} \Pr(P_{\symbf{X}} = q)\\
 &\le |\mathcal{D}\cap\mathcal{P}_N| \max_{q\in\mathcal{D}\cap\mathcal{P}_N}\Pr(P_{\symbf{X}} = q)\\
 &\le (N+1)^m \max_{q\in\mathcal{D}\cap\mathcal{P}_N}\mathrm{e}^{-N\KL{q}{p}}\\
 &\le (N+1)^m \sup_{q\in\mathcal{D}}\mathrm{e}^{-N\KL{q}{p}}\\
 &= (N+1)^m \mathrm{e}^{-N\inf_{q\in\mathcal{D}}\KL{q}{p}}.
\end{align*}
\end{proof}
\end{frame}


\begin{frame}{サノフの定理の証明}
\footnotesize
\sanov
\begin{proof}
KL divergenceの連続性より、
$\mathcal{D}\cap\mathbb{Q}^m$の列$(q_n\in\mathcal{D}\cap\mathcal{P}_N)_{n\ge 0}$で
$\lim_{n\to\infty} \KL{q_n}{p} = \inf_{q\in\mathcal{D}} \KL{q}{p}$を満たすものがある。

\begin{align*}
\Pr(P_{\symbf{X}}\in\mathcal{D}) &= \sum_{q\in\mathcal{D}\cap\mathcal{P}_N} \Pr(P_{\symbf{X}} = q)
 \ge \Pr(P_{\symbf{X}}=q_N)
 \ge \frac1{(N+1)^m}\mathrm{e}^{-N\KL{q_N}{p}}
\end{align*}
よって
\begin{align*}
\liminf_{N\to\infty}\frac1N
\log\Pr(P_{\symbf{X}}\in\mathcal{D}) &\ge -\inf_{q\in\mathcal{D}}\KL{q}{p}.\qedhere
\end{align*}
\end{proof}
\end{frame}

\begin{frame}{二項分布($m=2$)の場合}
\footnotesize
二項分布の場合$\sum_{k=1}^n X_k=N_1(\symbf{X})$であり、$P_{\symbf{X}}=\left(\frac{N-N_1(\symbf{X})}N,\,\frac{N_1(\symbf{X})}N\right)$と一対一に対応する。

\begin{align*}
\Pr\left(\sum_{k=1}^N X_k \ge Na\right)
&=
\Pr\left(\frac{N_1(\symbf{X})}{N} \ge a\right)
\end{align*}
$\mathcal{D}\coloneq \{(p_0,\,p_1)\mid p_1\ge a\}$とすると、
\begin{align*}
\Pr\left(\sum_{k=1}^N X_k \ge Na\right)
&=
\Pr\left(P_{\symbf{X}} \in\mathcal{D}\right)
\end{align*}
サノフの定理より、これの指数部は
\begin{align*}
-\inf_{q\in\mathcal{D}} \KL{(1-q,\,q)}{(1-p,\,p)}
\end{align*}
である。
\begin{align*}
\inf_{q\in\mathcal{D}} \KL{(1-q,\,q)}{(1-p,\,p)}&= \inf_{q\ge a} (1-q)\log\frac{1-q}{1-p} + q\log\frac{q}{p}\\
&= 
\begin{cases}
0&\text{if } a\le p\\
(1-a)\log\frac{1-a}{1-p} + a\log\frac{a}{p}& \text{otherwise.}
\end{cases}
\end{align*}
これはクラメールの定理で得られるレート関数$I_X(a)$と等しい。
\end{frame}

\begin{frame}{課題}
\end{frame}
\end{document}
